# æµå¼è¾“å‡ºä¸å·¥å…·è°ƒç”¨çš„å¤„ç†å·®å¼‚

æœ¬æ–‡æ¡£è¯´æ˜ OpenCode åœ¨å¤„ç†å¤§è¯­è¨€æ¨¡å‹æµå¼è¾“å‡ºæ—¶ï¼Œå¦‚ä½•åŒºåˆ†"æ–‡æœ¬è¾“å‡º"å’Œ"å·¥å…·è°ƒç”¨"ä¸¤ç§ä¸åŒåœºæ™¯ï¼Œé¿å…åœ¨æ•°æ®ä¸å®Œæ•´æ—¶æ‰§è¡Œé”™è¯¯æ“ä½œã€‚

## æ ¸å¿ƒåŸåˆ™

OpenCode ç¡®å®**ä¸æ˜¯"æ‹¿åˆ°ä¸å®Œæ•´æ•°æ®å°±æ‰§è¡Œæ“ä½œ"**ï¼Œè€Œæ˜¯é€šè¿‡ä¸¥æ ¼çš„**çŠ¶æ€æœº**æœºåˆ¶æ§åˆ¶ï¼š

- **æ–‡æœ¬è¾“å‡º**ï¼šæµå¼æ˜¾ç¤ºï¼Œä¸æ¶‰åŠæ‰§è¡Œæ“ä½œ
- **å·¥å…·è°ƒç”¨**ï¼šå¿…é¡»ç­‰å¾…å‚æ•°å®Œæ•´æ‰æ‰§è¡Œ

## æ–‡æœ¬è¾“å‡ºï¼ˆæµå¼æ˜¾ç¤ºï¼‰

### å¤„ç†æµç¨‹

```
text-delta â†’ å¢é‡ç´¯ç§¯ â†’ å®æ—¶æ˜¾ç¤º
```

### ç‰¹ç‚¹

- åªæ˜¯æŠŠæ”¶åˆ°çš„å­—ç¬¦è¿½åŠ æ˜¾ç¤º
- ä¸æ¶‰åŠä»»ä½•"æ‰§è¡Œæ“ä½œ"
- ç›®çš„æ˜¯ï¼šç”¨æˆ·å®æ—¶çœ‹åˆ°è¾“å‡ºè¿›åº¦

### çŠ¶æ€å˜åŒ–

```
ç©ºæ–‡æœ¬ "" â†’ å¢é‡1 "Hel" â†’ å¢é‡2 "lo " â†’ å¢é‡3 "World" â†’ å®Œæ•´ "Hello World"
```

### ç”¨æˆ·çœ‹åˆ°çš„æ•ˆæœ

| æ—¶é—´ | UI æ˜¾ç¤º | æ•°æ®çŠ¶æ€                   |
| ---- | ------- | -------------------------- |
| T0   | æ—       | åˆå§‹çŠ¶æ€                   |
| T1   | `H`     | text-delta("H")            |
| T2   | `He`    | text-delta("e")            |
| T3   | `Hel`   | text-delta("l")            |
| T4   | `Hell`  | text-delta("l")            |
| T5   | `Hello` | text-delta("o") + text-end |

## å·¥å…·è°ƒç”¨ï¼ˆå¿…é¡»å®Œæ•´æ‰æ‰§è¡Œï¼‰

### å¤„ç†æµç¨‹

```
tool-input-start (å‚æ•°ä¸ºç©º) â†’ tool-call (å‚æ•°å®Œæ•´) â†’ tool-result (æ‰§è¡Œå®Œæˆ)
```

### çŠ¶æ€æœº

```typescript
case "tool-input-start":
  // é˜¶æ®µ 1: å·¥å…·è°ƒç”¨å¼€å§‹ï¼Œå‚æ•°ä¸ºç©º
  const part = await Session.updatePart({
    id: toolcalls[value.id]?.id ?? Identifier.ascending("part"),
    messageID: input.assistantMessage.id,
    type: "tool",
    tool: value.toolName,
    callID: value.id,
    state: {
      status: "pending",      // â† å¾…å®šçŠ¶æ€
      input: {},              // â† å‚æ•°ä¸ºç©º
      raw: "",                // â† åŸå§‹æ–‡æœ¬ä¸ºç©º
    },
  })
  // ä¸æ‰§è¡Œä»»ä½•å·¥å…·ï¼
  break

case "tool-call":
  // é˜¶æ®µ 2: å‚æ•°å®Œæ•´ï¼Œå·¥å…·å°†ç”± AI SDK çš„ streamText å†…éƒ¨æ‰§è¡Œ
  // OpenCode é€šè¿‡çŠ¶æ€æœºç¡®ä¿åªåœ¨å‚æ•°å®Œæ•´æ—¶æ‰æ‰§è¡Œå·¥å…·
  const match = toolcalls[value.toolCallId]
  if (match) {
    await Session.updatePart({
      ...match,
      tool: value.toolName,
      state: {
        status: "running",      // â† è¿è¡Œä¸­çŠ¶æ€
        input: value.input,     // â† å®Œæ•´å‚æ•°å·²è§£æ
        time: {
          start: Date.now(),
        },
      },
      metadata: value.providerMetadata,
    })

    // æ³¨æ„ï¼šå·¥å…·çš„çœŸæ­£æ‰§è¡Œç”± AI SDK çš„ streamText å‡½æ•°å†…éƒ¨ç®¡ç†
    // processor.ts åªè´Ÿè´£æ›´æ–°å·¥å…·çŠ¶æ€ï¼Œä¸ç›´æ¥è°ƒç”¨å·¥å…·
  }
  break

case "tool-result":
  // é˜¶æ®µ 3: å·¥å…·æ‰§è¡Œç»“æœï¼ˆçŠ¶æ€å®Œæˆï¼‰
  const match = toolcalls[value.toolCallId]
  if (match && match.state.status === "running") {
    await Session.updatePart({
      ...match,
      state: {
        status: "completed",
        input: value.input,
        output: value.output.output,
        metadata: value.output.metadata,
        title: value.output.title,
        time: {
          start: match.state.time.start,
          end: Date.now(),
        },
        attachments: value.output.attachments,
      },
    })
    delete toolcalls[value.toolCallId]
  }
  break
```

### çŠ¶æ€è½¬æ¢å›¾

```
pending (tool-input-start)
    â†“ [å‚æ•°è§£æå®Œæˆ]
    â†“
running (tool-call)
    â†“ [å·¥å…·æ‰§è¡Œä¸­]
    â†“
completed (tool-result)
    â†“ [ä¿å­˜ç»“æœï¼Œä» toolcalls ç§»é™¤]
    â†“
ä» UI/å†…å­˜ä¸­åˆ é™¤
```

### ç”¨æˆ·çœ‹åˆ°çš„æ•ˆæœ

| æ—¶é—´ | UI æ˜¾ç¤º                         | æ•°æ®çŠ¶æ€                           |
| ---- | ------------------------------- | ---------------------------------- |
| T0   | æ—                               | åˆå§‹çŠ¶æ€                           |
| T1   | `ğŸ” read(file.ts) [pending...]` | tool-input-startï¼Œstatus = pending |
| T2   | `ğŸ” read(file.ts) [running...]` | tool-callï¼Œstatus = running        |
| T3   | `âœ… read(file.ts) [completed]`  | tool-resultï¼Œstatus = completed    |

## å¯¹æ¯”æ€»ç»“

| æ•°æ®ç±»å‹     | æ˜¯å¦æµå¼å¤„ç† | æ˜¯å¦ç­‰å®Œæ•´æ‰æ‰§è¡Œ      | ç›®çš„             |
| ------------ | ------------ | --------------------- | ---------------- |
| **æ–‡æœ¬è¾“å‡º** | âœ… æµå¼æ˜¾ç¤º  | âŒ ä¸æ¶‰åŠæ‰§è¡Œ         | å®æ—¶åé¦ˆè¾“å‡ºè¿›åº¦ |
| **æ¨ç†å†…å®¹** | âœ… æµå¼æ˜¾ç¤º  | âŒ ä¸æ¶‰åŠæ‰§è¡Œ         | å®æ—¶æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹ |
| **å·¥å…·è°ƒç”¨** | âœ… æµå¼æ¥æ”¶  | âœ… **å¿…é¡»å®Œæ•´æ‰æ‰§è¡Œ** | ç¡®ä¿å‚æ•°æ­£ç¡®æ€§   |

## æ ¸å¿ƒè®¾è®¡

### çŠ¶æ€æœºçš„ä½œç”¨

é€šè¿‡çŠ¶æ€æœºç®¡ç†æ•°æ®ä»"ä¸å®Œæ•´"åˆ°"å®Œæ•´"çš„è½¬æ¢ï¼š

- **pending**: å‚æ•°ä¸å®Œæ•´ï¼Œä¸æ‰§è¡Œå·¥å…·
- **running**: å‚æ•°å®Œæ•´ï¼Œå·¥å…·æ‰§è¡Œä¸­
- **completed**: å·¥å…·æ‰§è¡Œå®Œæˆ
- **error**: å·¥å…·æ‰§è¡Œå¤±è´¥ï¼ˆå¦‚æƒé™æ‹’ç»æˆ–æ‰§è¡Œé”™è¯¯ï¼‰

### ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·è®¾è®¡ï¼Ÿ

1. **é¿å…é”™è¯¯æ‰§è¡Œ**ï¼šå¦‚æœåœ¨å‚æ•°ä¸å®Œæ•´æ—¶å°±è°ƒç”¨å·¥å…·ï¼Œå¯èƒ½å¯¼è‡´å·¥å…·æ‰§è¡Œå¤±è´¥æˆ–äº§ç”Ÿé”™è¯¯ç»“æœ
2. **ç”¨æˆ·ä½“éªŒ**ï¼šç”¨æˆ·å®æ—¶çœ‹åˆ°å·¥å…·è°ƒç”¨çš„çŠ¶æ€å˜åŒ–ï¼ˆpending â†’ running â†’ completedï¼‰
3. **æ•°æ®å®‰å…¨**ï¼šæ¯æ¬¡çŠ¶æ€å˜åŒ–éƒ½ä¿å­˜åˆ°æ•°æ®åº“ï¼Œè¿›ç¨‹å´©æºƒä¸ä¼šä¸¢å¤±è¿›åº¦
4. **å¯è¿½è¸ª**ï¼šå¯ä»¥æŸ¥çœ‹æ¯ä¸ªå·¥å…·è°ƒç”¨çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ–‡æœ¬å¯ä»¥æµå¼æ˜¾ç¤ºï¼Œä½†å·¥å…·å¿…é¡»ç­‰å®Œæ•´ï¼Ÿ

**A**: å› ä¸ºä¸¤è€…ç›®çš„ä¸åŒï¼š

- æ–‡æœ¬è¾“å‡ºåªæ˜¯æ˜¾ç¤ºå†…å®¹ï¼Œä¸æ¶‰åŠ"æ‰§è¡Œ"æ“ä½œï¼Œæ‰€ä»¥å¯ä»¥æµå¼æ˜¾ç¤º
- å·¥å…·è°ƒç”¨æ¶‰åŠå®é™…çš„å‡½æ•°æ‰§è¡Œï¼Œéœ€è¦å®Œæ•´çš„å‚æ•°æ‰èƒ½æ­£ç¡®æ‰§è¡Œ

### Q2: å¦‚æœç½‘ç»œä¸­æ–­ï¼Œå·¥å…·è°ƒç”¨ä¼šæ‰§è¡Œå—ï¼Ÿ

**A**: ä¸ä¼šã€‚åªæœ‰æ”¶åˆ° `tool-call` äº‹ä»¶ï¼ˆå‚æ•°å®Œæ•´ï¼‰æ—¶æ‰ä¼šæ‰§è¡Œå·¥å…·ã€‚å¦‚æœåœ¨ `tool-input-start` åå°±ä¸­æ–­ï¼Œå·¥å…·æ°¸è¿œä¸ä¼šæ‰§è¡Œã€‚

### Q3: å¦‚ä½•çŸ¥é“å·¥å…·è°ƒç”¨æ˜¯å¦å®Œæˆï¼Ÿ

**A**: é€šè¿‡çŠ¶æ€æœºã€‚åªæœ‰æ”¶åˆ° `tool-result` äº‹ä»¶ï¼Œä¸”çŠ¶æ€ä¸º `completed`ï¼Œæ‰è¡¨ç¤ºå·¥å…·è°ƒç”¨å®Œæˆã€‚

### Q4: å¦‚æœå·¥å…·æ‰§è¡Œå¤±è´¥ä¼šæ€æ ·ï¼Ÿ

**A**: å·¥å…·æ‰§è¡Œå¤±è´¥æœ‰ä¸¤ç§æƒ…å†µï¼š

1. **æ‰§è¡Œé”™è¯¯**ï¼šé€šè¿‡ `tool-error` äº‹ä»¶å¤„ç†ï¼ŒçŠ¶æ€è®¾ç½®ä¸º `error`ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯
2. **æƒé™æ‹’ç»**ï¼šåŒæ ·é€šè¿‡ `tool-error` å¤„ç†ï¼Œå¯èƒ½ä¸­æ–­æ•´ä¸ªä¼šè¯
3. **è¿”å›é”™è¯¯ä½†æœªæŠ›å‡ºå¼‚å¸¸**ï¼šå¦‚æœå·¥å…·è¿”å›äº†ç»“æœä½†åŒ…å«é”™è¯¯ä¿¡æ¯ï¼ŒçŠ¶æ€ä¼šæ˜¯ `completed`ï¼Œ`output` åŒ…å«é”™è¯¯å†…å®¹

ä¾‹å¦‚ï¼Œæƒé™è¢«æ‹’ç»æ—¶ä¼šè§¦å‘ `tool-error` äº‹ä»¶ï¼š

```typescript
case "tool-error": {
  const match = toolcalls[value.toolCallId]
  if (match && match.state.status === "running") {
    await Session.updatePart({
      ...match,
      state: {
        status: "error",     // â† é”™è¯¯çŠ¶æ€
        input: value.input,
        error: value.error,  // â† é”™è¯¯ä¿¡æ¯
        time: { start: match.state.time.start, end: Date.now() },
      },
    })
    delete toolcalls[value.toolCallId]
  }
  break
}
```

## æ€»ç»“

OpenCode é€šè¿‡**çŠ¶æ€æœº**æœºåˆ¶ï¼Œå·§å¦™åœ°è§£å†³äº†"å®æ—¶åé¦ˆ"å’Œ"æ‰§è¡Œå®‰å…¨"çš„çŸ›ç›¾ï¼š

- **æµå¼è¾“å‡º**ï¼šç”¨äºæ˜¾ç¤ºè¿›åº¦ï¼Œç”¨æˆ·å®æ—¶çœ‹åˆ°å˜åŒ–
- **çŠ¶æ€æ§åˆ¶**ï¼šç”¨äºç¡®ä¿æ‰§è¡Œå®‰å…¨ï¼Œé¿å…åœ¨æ•°æ®ä¸å®Œæ•´æ—¶æ‰§è¡Œæ“ä½œ

è¿™ç§è®¾è®¡æ—¢ä¿è¯äº†ç”¨æˆ·ä½“éªŒï¼Œåˆé¿å…äº†æ½œåœ¨çš„é”™è¯¯æ‰§è¡Œã€‚
