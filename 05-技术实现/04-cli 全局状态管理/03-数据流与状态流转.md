# 全局状态管理 - 数据流与状态流转

## 1. CLI 启动流程

```
用户运行命令
  opencode run
    │
    ▼
┌─────────────────────────────────────────────────────┐
│ 1. index.ts - yargs middleware                       │
│  ├─ Log.init() - 初始化日志                          │
│  ├─ 设置环境变量 (AGENT=1, OPENCODE=1)              │
│  └─ 执行命令处理器                                   │
└─────────────────────────┬───────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│ 2. Global 初始化                                      │
│  ├─ 创建目录 (data, config, state, log, bin)        │
│  ├─ 检查缓存版本                                     │
│  └─ 清理过期缓存                                     │
└─────────────────────────┬───────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│ 3. Flag 初始化                                        │
│  ├─ 读取环境变量                                     │
│  ├─ 解析布尔值 (truthy)                              │
│  └─ 解析数字 (number)                               │
└─────────────────────────┬───────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│ 4. Installation 初始化                                │
│  ├─ 读取编译时常量 (VERSION, CHANNEL)                │
│  ├─ 检测安装方式 (npm, brew, curl 等)               │
│  └─ 构建 USER_AGENT                                 │
└─────────────────────────┬───────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│ 5. Log 初始化                                         │
│  ├─ 确定日志级别 (DEBUG/INFO/WARN/ERROR)           │
│  ├─ 截断或创建日志文件 (dev.log 或 时间戳.log)     │
│  └─ 清理旧日志文件 (保留最新10个)                   │
└─────────────────────────┬───────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│ 6. 进入命令处理器 (如 run.ts)                         │
│  └─ Instance.provide({ directory, init, fn })       │
│     ├─ directory: process.cwd()                     │
│     ├─ init?: 可选的初始化函数                        │
│     └─ fn: 命令处理函数                               │
└─────────────────────────┬───────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│ 7. Instance 创建流程                                  │
│  ┌─────────────────────────────────────────────────┐│
│  │ cache.get(directory) ?                           ││
│  │   ├─ YES: 使用缓存的实例                         ││
│  │   └─ NO:  创建新实例                            ││
│  │       ├─ Project.fromDirectory(directory)      ││
│  │       │   ├─ Filesystem.up() 向上查找 .git     ││
│  │       │   ├─ 获取 git root commit ID           ││
│  │       │   ├─ 确定 worktree 路径                 ││
│  │       │   └─ 从 Storage 读取/创建 Project.Info  ││
│  │       ├─ context.provide(ctx, async () => {     ││
│  │       │     await input.init?.()                ││
│  │       │   })                                    ││
│  │       └─ cache.set(directory, instancePromise)  ││
│  └─────────────────────────────────────────────────┘│
└─────────────────────────┬───────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│ 8. AsyncLocalStorage 上下文设置                       │
│  context.provide({                                   │
│    directory, worktree, project                       │
│  }, async () => {                                     │
│    // 以下所有操作都在这个上下文中                     │
│  })                                                   │
└─────────────────────────┬───────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│ 9. 实例状态初始化 (首次访问时)                        │
│  ┌─────────────────────────────────────────────────┐│
│  │ Config.state()                                    ││
│  │   ├─ 加载全局配置 (~/.config/opencode/)         ││
│  │   ├─ 加载项目配置 (opencode.json)               ││
│  │   ├─ 加载 .opencode 目录                        ││
│  │   │   ├─ command/*.md                           ││
│  │   │   ├─ agent/*.md                             ││
│  │   │   └─ plugin/*.{ts,js}                      ││
│  │   ├─ 应用 Flag 覆盖                             ││
│  │   └─ 返回 { config, directories }              ││
│  ├─────────────────────────────────────────────────┤│
│  │ Bus.state()                                      ││
│  │   └─ 返回 { subscriptions: Map() }              ││
│  ├─────────────────────────────────────────────────┤│
│  │ Storage.state()                                  ││
│  │   ├─ 运行数据迁移                               ││
│  │   └─ 返回 { dir: storage路径 }                 ││
│  └─────────────────────────────────────────────────┘│
└─────────────────────────┬───────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│ 10. 执行业务逻辑                                      │
│   ├─ Config.get() - 获取配置                         │
│   ├─ Session.create() - 创建会话                      │
│   ├─ Bus.subscribe() - 订阅事件                      │
│   └─ ...                                             │
└─────────────────────────┬───────────────────────────┘
                          │
                          ▼
                    命令执行完成
```

---

## 2. 状态初始化时序图

```
时间线 →

T0: CLI 启动
    ├─ Global.Path (常量，立即可用)
    ├─ Flag (常量，立即可用)
    ├─ Installation (常量，立即可用)
    └─ Log.init() (异步，阻塞)

T1: 进入命令
    └─ Instance.provide()

T2: 检查缓存
    ├─ cache.get(directory) → null
    └─ 创建新实例

 T3: Project.fromDirectory()
     ├─ Filesystem.up({ targets: [".git"], start: directory })
     ├─ 读取 .git/opencode 或 git rev-list --max-parents=0
     ├─ git rev-parse --show-toplevel
     └─ Storage.read/write(["project", id])

T4: context.provide() 设置 AsyncLocalStorage
    └─ 所有子异步操作现在可以访问上下文

T5: 首次访问 Instance.directory/worktree/project
    └─ context.use() 返回上下文数据

T6: 首次访问 Config.state()
    ├─ Auth.all() (读取 auth.json)
    ├─ Config.global() (lazy 加载)
    ├─ 加载项目配置文件
    ├─ 加载 .opencode 目录
    └─ 返回 { config, directories }

T7: 首次访问 Bus.state()
    └─ 返回 { subscriptions: Map() }

T8: 首次访问 Storage.state()
    ├─ 检查 migration 版本
    ├─ 运行迁移脚本
    └─ 返回 { dir }

T9: 后续访问
    ├─ 所有 state() 调用返回缓存值
    ├─ context.use() 返回缓存的上下文
    └─ 不再执行初始化

 T10: Instance.dispose()
     ├─ State.dispose(directory)
     │   ├─ Config state dispose
     │   ├─ Bus state dispose
     │   └─ Storage state dispose
     ├─ cache.delete(directory)
     └─ GlobalBus.emit("event", {
          directory,
          payload: {
            type: "server.instance.disposed",
            properties: { directory }
          }
        })
```

---

## 3. 事件流转图

### 3.1 实例内事件流转

```
模块 A                          Bus                            模块 B
│                               │                               │
│  1. Bus.publish(Event, data)  │                               │
│ ─────────────────────────────→│                               │
│                               │  2. 查找订阅者                 │
│                               │  subscriptions.get(eventType) │
│                               │                               │
│                               │  3. 调用订阅者                 │
│                               │ ───────────────────────────→│
│                               │                               │
│                               │                               │  处理事件
│                               │                               │
│                               │  4. 查找通配符订阅者            │
│                               │  subscriptions.get("*")      │
│                               │                               │
│                               │  5. 调用通配符订阅者            │
│                               │ ───────────────────────────→│
│                               │                               │  处理所有事件
│                               │                               │
│  6. GlobalBus.emit()          │                               │
│ │←───────────────────────────│                               │
│  7. 返回 Promise.all()        │                               │
│ │←───────────────────────────│                               │
```

### 3.2 跨实例事件流转

```
实例 1                          GlobalBus                       实例 2
│                                                               │
│  1. Bus.publish(Event, data)                                 │
│ ──────────────────────────────────────────────────────────→│
│                                                               │
│                                                               │  2. 监听所有事件
│                                                               │  GlobalBus.on("event")
│                                                               │
│                                                               │  3. 检查事件来源
│                                                               │  if (directory === ...)
│                                                               │
│                                                               │  4. 处理跨实例事件
```

---

## 4. 配置加载优先级

```
优先级从低到高 (后加载的覆盖先加载的):

┌──────────────────────────────────────────────────────┐
│ 优先级 1: 全局配置 (~/.config/opencode/)              │
│ ├─ config.json                                        │
│ ├─ opencode.json                                      │
│ └─ opencode.jsonc                                     │
│                                                        │
│ 优先级 2: 自定义配置文件                                │
│ └─ Flag.OPENCODE_CONFIG (环境变量指定的文件路径)      │
│                                                        │
│ 优先级 3: 项目配置 (从 directory 向上查找)             │
│ ├─ opencode.jsonc                                     │
│ └─ opencode.json                                      │
│                                                        │
│ 优先级 4: 自定义配置内容                                │
│ └─ Flag.OPENCODE_CONFIG_CONTENT (环境变量 JSON 内容)  │
│                                                        │
│ 优先级 5: Auth 提供的配置                             │
│ └─ well-known 端点的 config                            │
│                                                        │
│ 优先级 6: .opencode 目录配置                          │
│ ├─ ~/.config/opencode/ (全局)                         │
│ ├─ <worktree>/.opencode/ (向上查找)                  │
│ ├─ ~/.opencode/ (向上查找)                           │
│ ├─ Flag.OPENCODE_CONFIG_DIR (指定目录)                │
│ │   ├─ opencode.jsonc / opencode.json               │
│ │   ├─ command/**/*.md                               │
│ │   ├─ agent/**/*.md                                 │
│ │   ├─ mode/*.md                                      │
│ │   └─ plugin/*.{ts,js}                              │
│                                                        │
│ 优先级 7: Flag 环境变量覆盖                            │
│ ├─ OPENCODE_DISABLE_AUTOUPDATE                       │
│ ├─ OPENCODE_DISABLE_PRUNE                             │
│ ├─ OPENCODE_PERMISSION                               │
│ ├─ OPENCODE_CONFIG (已在优先级2处理)                  │
│ └─ ... (34个环境变量)                                │
└──────────────────────────────────────────────────────┘

合并规则:
- 深度合并 (mergeDeep)
- plugin 数组特殊处理 (Set 去重后合并)
- 后加载的配置覆盖先加载的同名字段
```

---

## 5. Storage 数据结构

```
~/.local/share/opencode/storage/
│
├── project/
│   ├── {git-root-commit}.json
│   │   {
│   │     "id": "abc123...",
│   │     "worktree": "/path/to/project",
│   │     "vcs": "git",
│   │     "name": "my-project",
│   │     "icon": { "url": "...", "color": "..." },
│   │     "time": {
│   │       "created": 1234567890,
│   │       "updated": 1234567890,
│   │       "initialized": 1234567890
│   │     }
│   │   }
│   │
│   └── global.json
│       {
│         "id": "global",
│         "worktree": "/",
│         "vcs": undefined,
│         "time": { ... }
│       }
│
├── session/
│   ├── {projectID}/
│   │   ├── {sessionID}.json
│   │   │   {
│   │   │     "id": "session-123",
│   │   │     "projectID": "abc123...",
│   │   │     "directory": "/path/to/project",
│   │   │     "parentID": "session-parent",
│   │   │     "title": "My Session",
│   │   │     "version": "1.0.0",
│   │   │     "time": {
│   │   │       "created": 1234567890,
│   │   │       "updated": 1234567890
│   │   │     },
│   │   │     "summary": {
│   │   │       "additions": 10,
│   │   │       "deletions": 5,
│   │   │       "files": 3
│   │   │     },
│   │   │     "share": { "url": "https://..." },
│   │   │     "revert": { ... }
│   │   │   }
│   │   │
│   │   └── {sessionID}-2.json
│   │
│   └── global/
│       └── {sessionID}.json
│
├── message/
│   ├── {messageID}.json (消息元数据)
│   │
│   └── part/
│       └── {messageID}/
│           └── {partID}.json
│               {
│                 "id": "part-123",
│                 "messageID": "msg-123",
│                 "content": "...",
│                 ...
│               }
│
├── session_diff/
│   └── {sessionID}.json
│       [
│         { "path": "file.ts", "additions": 10, "deletions": 5 },
│         { "path": "file2.ts", "additions": 5, "deletions": 2 }
│       ]
│
└── migration
    "2"  // 当前迁移版本 (MIGRATIONS 数组长度)
```

---

## 6. State 状态查找流程

```
调用 Instance.state() 返回的函数:
│
├─ Step 1: 获取 root key
│  └─ root() → Instance.directory → "/path/to/project"
│
├─ Step 2: 查找该 root key 的状态映射
│  └─ recordsByKey.get("/path/to/project") → Map<init, Entry>
│
│   ├─ 不存在: 创建新 Map 并存储
│   │  recordsByKey.set("/path/to/project", new Map())
│   │
│   └─ 存在: 使用已有 Map
│
├─ Step 3: 查找该 init 函数的状态
│  └─ entries.get(init) → Entry
│
│   ├─ 存在: 返回缓存的状态
│   │  return entry.state
│   │
│   └─ 不存在: 创建新状态
│      ├─ const state = init()
│      ├─ const entry = { state, dispose }
│      ├─ entries.set(init, entry)
│      └─ return state
│
└─ 结果: 返回状态实例
```

---

## 7. Instance.dispose() 清理流程

```
Instance.dispose(directory)
│
├─ Step 1: 记录日志
│  └─ Log.info("disposing instance", { directory })
│
├─ Step 2: 清理所有状态
│  └─ State.dispose(directory)
│      │
│      ├─ 获取该 directory 的所有状态
│      │  entries = recordsByKey.get(directory)
│      │
│      ├─ 遍历所有状态并调用 dispose
│      │  for (const entry of entries.values()) {
│      │    if (entry.dispose) {
│      │      await entry.dispose(entry.state)
│      │    }
│      │  }
│      │
│      ├─ 清空状态映射
│      │  entries.clear()
│      │
│      └─ 删除该 directory 的映射
│         recordsByKey.delete(directory)
│
├─ Step 3: 删除实例缓存
│  └─ cache.delete(directory)
│
 └─ Step 4: 发送全局事件
    └─ GlobalBus.emit("event", {
         directory: Instance.directory,
         payload: {
           type: "server.instance.disposed",
           properties: {
             directory: Instance.directory
           }
         }
       })
```

---

## 8. 多项目并行操作示例

```
场景: 同时在两个项目中运行 opencode

终端 1:                    终端 2:
$ cd /project/a           $ cd /project/b
$ opencode run            $ opencode run
    │                          │
    ▼                          ▼
 Instance.provide({          Instance.provide({
   directory: "/project/a",      directory: "/project/b",
   fn: () => {                   fn: () => {
     // 业务逻辑                   // 业务逻辑
   }                            }
 })                          })
    │                          │
    ▼                          ▼
缓存查找                   缓存查找
cache.get("/project/a")    cache.get("/project/b")
    │                          │
    ▼                          ▼
创建实例 A                  创建实例 B
Project: "abc123..."       Project: "def456..."
    │                          │
    ▼                          ▼
AsyncLocalStorage A         AsyncLocalStorage B
{                            {
  directory: "/project/a",    directory: "/project/b",
  worktree: "/project/a",     worktree: "/project/b",
  project: { id: "abc..." }   project: { id: "def..." }
}                            }
    │                          │
    ▼                          ▼
独立状态空间:               独立状态空间:
├─ Config A                 ├─ Config B
├─ Bus A                     ├─ Bus B
├─ Storage A                 ├─ Storage B
└─ ...                       └─ ...
    │                          │
    ▼                          ▼
独立配置                    独立配置
├─ opencode.json (a)        ├─ opencode.json (b)
├─ .opencode/ (a)           ├─ .opencode/ (b)
└─ ...                       └─ ...
    │                          │
    ▼                          ▼
独立会话:                   独立会话:
Storage/session/abc123/    Storage/session/def456/
    │                          │
    ▼                          ▼
独立事件总线:               独立事件总线:
Bus.publish()               Bus.publish()
(只影响实例 A)              (只影响实例 B)
    │                          │
    ▼                          ▼
跨实例事件 (通过 GlobalBus):
GlobalBus.emit("event", {
  directory: "/project/a",
  payload: { ... }
})
GlobalBus.on("event", ({ directory }) => {
  // 可以监听其他实例的事件
})
```

---

## 9. 典型操作的状态流转

### 9.1 创建会话

```
用户: 创建新会话
    │
    ▼
Session.create()
    │
    ├─ Instance.directory  → "/project/a"
    ├─ Instance.project   → { id: "abc123..." }
    │
    ▼
 生成会话 ID
     │
     ▼
Storage.write([
  "session",
  Instance.project.id,
  sessionID
], sessionInfo)
    │
    ▼
 Bus.publish(Session.Event.Created, {
   info: sessionInfo
 })
     │
     ├─ 触发本地订阅者
     ├─ 触发通配符订阅者
     └─ GlobalBus.emit("event", {
          directory: Instance.directory,
          payload: {
            type: Session.Event.Created.type,
            properties: { info: sessionInfo }
          }
        })
     │
     ▼
 返回会话信息
```

### 9.2 发送消息

```
 用户: 发送消息 "帮我创建一个文件"
     │
     ▼
Session.append()
     │
     ├─ Storage.write([
     │    "message", messageID
     │  ], messageInfo)
     │
     ├─ Storage.write([
     │    "part", messageID, partID
     │  ], userPart)
     │
     ▼
Bus.publish(Session.Event.Updated, {
  info: updatedSession
})
    │
    ▼
Agent 处理消息
    │
    ├─ 读取配置 (Config.get())
    ├─ 读取工具 (Instance.state() - tools)
    ├─ LLM 调用
    │
    ▼
 Agent 回复
     │
     ├─ Storage.write([
     │    "part", messageID, partID
     │  ], assistantPart)
     │
     ├─ Bus.publish(Session.Event.Updated)
     │
     └─ 如果有工具调用:
         ├─ 执行工具
         ├─ Storage.write([
         │    "part", messageID, partID
         │  ], toolPart)
         └─ Bus.publish(Session.Event.Updated)
```

### 9.3 切换项目

```
 用户: $ cd /project/b && opencode run
     │
     ▼
命令处理器调用 Instance.provide({
   directory: "/project/b",
   init?: async () => { ... },
   fn: async () => {
     // 业务逻辑
   }
 })
     │
     ├─ cache.get("/project/b") → null (首次)
     │
     ▼
创建新实例
     │
     ├─ Project.fromDirectory("/project/b")
     │  └─ projectID = "def456..."
     │
     ├─ context.provide({
     │    directory: "/project/b",
     │    worktree: "/project/b",
     │    project: { id: "def456..." }
     │  })
     │
     ▼
独立的上下文和状态空间
    │
    ├─ Config (读取 /project/b/opencode.json)
    ├─ Bus (独立的订阅者)
    ├─ Storage (session/def456/)
    └─ ...
    │
    ▼
在新项目中工作
```

---

## 10. 性能优化点

### 10.1 缓存策略

```
┌─────────────────────────────────────────────────────┐
│ Instance 缓存                                        │
│ ├─ 每个目录创建一次实例                               │
│ ├─ 后续请求复用实例                                   │
│ └─ 避免重复检测 git 和加载配置                        │
│                                                       │
│ State 缓存                                           │
│ ├─ 每个状态只初始化一次                               │
│ ├─ 使用 init 函数作为 key                             │
│ └─ 返回相同的实例对象                                 │
│                                                       │
│ Config 缓存                                          │
│ ├─ 使用 lazy 延迟加载                                 │
│ ├─ 首次访问后缓存结果                                 │
│ └─ 同一实例内共享配置                                 │
│                                                       │
│ Storage 缓存                                         │
│ ├─ 文件系统缓存 (OS 级别)                            │
│ ├─ 文件锁防止并发冲突                                 │
│ └─ 批量操作减少 I/O                                  │
└─────────────────────────────────────────────────────┘
```

### 10.2 延迟初始化

```typescript
// Config 使用 lazy
const global = lazy(async () => {
  // 只在首次访问时执行
  return loadGlobalConfig()
})

// State 延迟初始化
const state = Instance.state(() => {
  // 只在首次调用 state() 时执行
  return createHeavyResource()
})

// 使用时才初始化
await Config.get() // 触发 lazy 初始化
state() // 触发 state 初始化
```

### 10.3 批量操作

```typescript
// 批量加载插件
const promises = []
for (const dir of directories) {
  promises.push(installDependencies(dir))
  promises.push(loadCommand(dir))
  promises.push(loadAgent(dir))
  promises.push(loadPlugin(dir))
}
await Promise.allSettled(promises)
```

---

## 11. 错误处理流程

```
操作失败
    │
    ▼
捕获错误 (try/catch)
    │
    ├─ NamedError 类型错误
    │  └─ Log.error("error", { data: e.toObject() })
    │
    ├─ 普通 Error
    │  └─ Log.error("error", {
    │       name, message, cause, stack
    │     })
    │
    └─ 其他错误
       └─ Log.error("error", { e })
    │
    ▼
格式化错误 (FormatError)
    │
    ├─ NamedError: 友好的错误信息
    ├─ 普通错误: 通用错误信息
    └─ 未知错误: 提示查看日志
    │
    ▼
UI.error() 显示错误
    │
    ▼
process.exitCode = 1
    │
    ▼
process.exit()
```

---

## 12. 数据流示例：完整的会话创建和处理

```
用户命令: opencode run

[1] CLI 启动
  ├─ Log.init()
  ├─ Global.Path 创建目录
  ├─ Flag 读取环境变量
  └─ Installation 读取版本

 [2] 创建实例
   ├─ Instance.provide({ directory: "/project", fn: () => { ... } })
   ├─ Project.fromDirectory("/project")
   │  ├─ Filesystem.up() 向上查找 .git
   │  ├─ git rev-list → "abc123..."
   │  ├─ Storage.read(["project", "abc123..."])
   │  └─ 不存在则创建新 Project
   └─ context.provide({ directory, worktree, project })

[3] 初始化状态
  ├─ Config.state()
  │  ├─ Auth.all() → 读取 auth.json
  │  ├─ Config.global() → 读取 ~/.config/opencode/
  │  ├─ 读取 /project/opencode.json
  │  ├─ 加载 /project/.opencode/
  │  └─ 返回 { config, directories }
  │
  ├─ Bus.state()
  │  └─ 返回 { subscriptions: Map() }
  │
  └─ Storage.state()
     ├─ 读取 migration 版本
     ├─ 运行迁移脚本 (如有)
     └─ 返回 { dir: storage路径 }

[4] 启动 CLI 交互
  ├─ 显示欢迎信息
  ├─ 列出项目会话
  └─ 等待用户输入

 [5] 用户输入: "帮我创建一个 utils.ts 文件"
   ├─ Session.create()
   │  ├─ 生成 sessionID
   │  ├─ Storage.write(["session", Instance.project.id, sessionID], sessionInfo)
   │  ├─ Bus.publish(Session.Event.Created)
   │  └─ GlobalBus.emit("event", {
        directory: Instance.directory,
        payload: {
          type: "session.created",
          properties: { info: sessionInfo }
        }
      })
   │
   ├─ Session.append()
   │  ├─ 生成 messageID, partID
   │  ├─ Storage.write(["message", messageID], messageInfo)
   │  ├─ Storage.write(["part", messageID, partID], userPart)
   │  └─ Bus.publish(Session.Event.Updated)
   │
   └─ Agent 处理
      ├─ Config.get() → 获取模型配置
      ├─ 构建提示词
      ├─ LLM 调用
      │  ├─ 读取上下文 (项目文件、历史消息)
      │  └─ 发送到 AI Provider
      │
      └─ LLM 返回工具调用
         └─ Write tool
            ├─ 文件路径: "/project/utils.ts"
            ├─ 文件内容: "..."
            │
            ├─ 执行工具
            │  ├─ Bun.write("/project/utils.ts", content)
            │  ├─ Storage.write(["part", messageID, partID], toolPart)
            │  └─ Bus.publish(Session.Event.Updated)
            │
            └─ LLM 返回文本回复
               ├─ Storage.write(["part", messageID, partID], assistantPart)
               ├─ Bus.publish(Session.Event.Updated)
               └─ 显示给用户

 [6] 用户退出
   ├─ Instance.dispose()
   │  ├─ State.dispose("/project")
   │  ├─ cache.delete("/project")
   │  └─ GlobalBus.emit("event", {
        directory: "/project",
        payload: {
          type: "server.instance.disposed",
          properties: { directory: "/project" }
        }
      })
   │
   └─ process.exit()
```

---

## 总结

OpenCode CLI 的全局状态管理采用多层架构:

1. **全局层**: Global, Log, Flag, Installation, Auth
2. **实例层**: Instance, Config, Bus, Storage
3. **持久层**: 文件系统存储

关键特性:

- ✅ 实例隔离 (AsyncLocalStorage)
- ✅ 状态缓存 (Instance.state)
- ✅ 事件驱动 (Bus, GlobalBus)
- ✅ 延迟初始化 (lazy, state)
- ✅ 资源清理 (dispose)
- ✅ 并发安全 (文件锁)

数据流:

```
用户请求 → 实例创建 → 上下文设置 → 状态初始化 → 业务逻辑 → 持久化 → 事件通知 → 响应
```
