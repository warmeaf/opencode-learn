# 全局状态管理 - 快速参考

## 核心概念速查

### 1. 全局常量（模块加载时初始化）

```typescript
import { Global } from "@/global"
import { Flag } from "@/flag"
import { Installation } from "@/installation"
import { Log } from "@/util/log"

// 直接使用
Global.Path.data // 数据目录
Global.Path.config // 配置目录
Flag.OPENCODE_CONFIG // 环境变量
Installation.VERSION // 版本号
Log.Default // 默认日志实例
```

### 2. 实例状态（项目级别）

```typescript
import { Instance } from "@/project/instance"

// 进入实例上下文
await Instance.provide({
  directory: "/path/to/project",
  async fn() {
    // 在这里访问实例相关的所有内容
    console.log(Instance.directory)
    console.log(Instance.worktree)
    console.log(Instance.project.id)
  },
})

// 获取当前目录（必须在上下文中）
const dir = Instance.directory
```

### 3. 创建实例状态

```typescript
import { Instance } from "@/project/instance"

// 定义状态
const myState = Instance.state(
  () => ({
    cache: new Map<string, any>(),
    counter: 0,
  }),
  async (state) => {
    // 清理逻辑
    state.cache.clear()
  },
)

// 使用状态
function doSomething() {
  const state = myState()
  state.counter++
  return state.counter
}
```

### 4. 配置管理

```typescript
import { Config } from "@/config/config"

// 获取配置
const config = await Config.get()
console.log(config.model)
console.log(config.agent.build)

// 获取配置目录
const dirs = await Config.directories()

// 更新配置
await Config.update({
  theme: "dark",
  model: "anthropic/claude-3",
})
```

### 5. 事件总线

```typescript
import { Bus } from "@/bus"
import { Session } from "@/session"

// 发布事件
await Bus.publish(Session.Event.Created, {
  info: sessionInfo,
})

// 订阅事件
const unsub = Bus.subscribe(Session.Event.Created, (event) => {
  console.log("会话创建:", event.properties.info.id)
})

// 取消订阅
unsub()

// 订阅所有事件
Bus.subscribeAll((event) => {
  console.log("事件:", event.type)
})

// 一次性订阅
Bus.once(Session.Event.Created, (event) => {
  console.log("只执行一次")
  return "done"
})
```

### 6. 存储操作

```typescript
import { Storage } from "@/storage/storage"

// 读取
const session = await Storage.read(["session", "project123", "session456"])

// 写入
await Storage.write(["session", "project123", "session456"], data)

// 更新（原子操作）
const updated = await Storage.update(["session", "project123", "session456"], (draft) => {
  draft.title = "新标题"
  draft.time.updated = Date.now()
})

// 删除
await Storage.remove(["session", "project123", "session456"])

// 列表
const sessions = await Storage.list(["session", "project123"])
// 返回: [["session", "project123", "session1"], ...]
```

### 7. 认证管理

```typescript
import { Auth } from "@/auth"

// 获取单个认证
const auth = await Auth.get("anthropic")

// 获取所有认证
const allAuth = await Auth.all()

// 设置认证
await Auth.set("anthropic", {
  type: "api",
  key: "sk-...",
})

// 删除认证
await Auth.remove("anthropic")
```

### 8. 日志记录

```typescript
import { Log } from "@/util/log"

// 创建 logger
const log = Log.create({ service: "myservice" })

// 记录日志
log.debug("调试信息", { key: "value" })
log.info("普通信息")
log.warn("警告信息")
log.error("错误信息", { error })

// 计时
const timer = log.time("操作", { id: "123" })
// ... 执行操作
timer.stop()

// 添加标签
const log2 = log.tag("tag1", "value1").tag("tag2", "value2")
log2.info("带标签的日志")

// 克隆 logger
const log3 = log.clone()
```

---

## 常用模式

### 模式 1: 创建 CLI 命令处理器

```typescript
import { Instance } from "@/project/instance"
import { Config } from "@/config/config"
import { Session } from "@/session"
import { Log } from "@/util/log"

const log = Log.create({ service: "mycommand" })

export async function run() {
  await Instance.provide({
    directory: process.cwd(),
    async fn() {
      // 获取配置
      const config = await Config.get()
      log.info("使用模型:", config.model)

      // 创建会话
      const session = await Session.create({
        title: "我的会话",
      })

      // ... 业务逻辑

      log.info("完成")
    },
  })
}
```

### 模式 2: 监听会话变化

```typescript
import { Instance } from "@/project/instance"
import { Bus } from "@/bus"
import { Session } from "@/session"

await Instance.provide({
  directory: process.cwd(),
  async fn() {
    // 订阅会话创建事件
    const unsub = Bus.subscribe(Session.Event.Created, async (event) => {
      const { info } = event.properties
      console.log(`新会话: ${info.title}`)

      // 处理会话...
    })

    // 订阅会话更新事件
    Bus.subscribe(Session.Event.Updated, (event) => {
      const { info } = event.properties
      console.log(`会话更新: ${info.id}`)
    })

    // 订阅会话删除事件
    Bus.subscribe(Session.Event.Deleted, (event) => {
      const { info } = event.properties
      console.log(`会话删除: ${info.title}`)
    })

    // 运行一段时间后取消订阅
    // unsub()
  },
})
```

### 模式 3: 实现自定义工具

```typescript
import { Instance } from "@/project/instance"
import { Storage } from "@/storage/storage"
import { Log } from "@/util/log"

const log = Log.create({ service: "mytool" })

const state = Instance.state(() => ({
  cache: new Map<string, any>(),
}))

export async function myTool(input: { key: string }) {
  const s = state()

  // 检查缓存
  if (s.cache.has(input.key)) {
    log.info("从缓存读取:", input.key)
    return s.cache.get(input.key)
  }

  // 从存储读取
  try {
    const data = await Storage.read(["mydata", input.key])
    s.cache.set(input.key, data)
    return data
  } catch (e) {
    log.error("读取失败:", { error: e })
    throw e
  }
}
```

### 模式 4: 跨实例通信

```typescript
import { GlobalBus } from "@/bus/global"
import { Session } from "@/session"

// 监听所有实例的会话事件
GlobalBus.on("event", ({ directory, payload }) => {
  if (payload.type === Session.Event.Created.type) {
    console.log(`实例 ${directory} 创建了新会话`)
  }
})

// 只监听特定实例
GlobalBus.on("event", ({ directory, payload }) => {
  if (directory === "/path/to/project") {
    console.log("目标实例的事件:", payload.type)
  }
})
```

### 模式 5: 配置扩展

```typescript
import { Config } from "@/config/config"
import { z } from "zod"

// 定义扩展配置
const MyConfig = z.object({
  myFeature: z.object({
    enabled: z.boolean().default(true),
    options: z.record(z.string()).optional(),
  }),
})

// 使用配置
export async function useMyFeature() {
  const config = await Config.get()

  // 从 experimental 字段读取自定义配置
  const myConfig = MyConfig.parse(config.experimental?.myFeature || {})

  if (myConfig.myFeature.enabled) {
    console.log("功能已启用", myConfig.myFeature.options)
  }
}
```

---

## 调试技巧

### 1. 查看所有实例

```typescript
import { Instance } from "@/project/instance"

// 注意: Instance.cache 是内部实现细节，不是公开 API
// 在正常代码中无法访问，仅用于源码调试
console.log("实例缓存大小:", Instance.cache?.size)
```

### 2. 查看当前上下文

```typescript
import { Instance } from "@/project/instance"

try {
  console.log("目录:", Instance.directory)
  console.log("工作树:", Instance.worktree)
  console.log("项目:", Instance.project)
} catch (e) {
  console.log("不在实例上下文中")
}
```

### 3. 监控所有事件

```typescript
import { Bus } from "@/bus"

Bus.subscribeAll((event) => {
  console.log(`[事件] ${event.type}`, event.properties)
})
```

### 4. 查看配置来源

```typescript
import { Config } from "@/config/config"

const directories = await Config.directories()
console.log("配置目录:", directories)

const config = await Config.get()
console.log("配置:", JSON.stringify(config, null, 2))
```

### 5. 查看存储结构

```typescript
import { Storage } from "@/storage/storage"
import { Global } from "@/global"

const storageDir = path.join(Global.Path.data, "storage")

// 列出所有项目
const projects = await Storage.list(["project"])
console.log("项目:", projects)

// 列出项目的会话
const sessions = await Storage.list(["session", "projectID"])
console.log("会话:", sessions)
```

---

## 性能优化清单

- ✅ 使用 `Instance.state()` 缓存状态
- ✅ 使用 `lazy` 延迟加载
- ✅ 及时取消事件订阅
- ✅ 批量存储操作
- ✅ 使用文件锁（Storage 自动处理）
- ✅ 及时释放实例 (`Instance.dispose()`)
- ✅ 避免重复配置加载
- ✅ 使用事件而非轮询

---

## 常见错误

### 错误 1: Context not found

```typescript
// ❌ 错误
const config = await Config.get()

// ✅ 正确
await Instance.provide({
  directory: process.cwd(),
  async fn() {
    const config = await Config.get()
  },
})
```

### 错误 2: 事件不触发

```typescript
// ❌ 错误: 不同实例
await Instance.provide({
  directory: "/project/a",
  async fn() {
    Bus.subscribe(Session.Event.Created, handler)
  },
})
await Instance.provide({
  directory: "/project/b",
  async fn() {
    Bus.publish(Session.Event.Created, { info: sessionInfo }) // 不会触发上面的订阅
  },
})

// ✅ 正确 1: 同一实例
await Instance.provide({
  directory: "/project/a",
  async fn() {
    Bus.subscribe(Session.Event.Created, handler)
    Bus.publish(Session.Event.Created, { info: sessionInfo })
  },
})

// ✅ 正确 2: 使用 GlobalBus
await Instance.provide({
  directory: "/project/a",
  async fn() {
    Bus.subscribe(Session.Event.Created, handler)
  },
})
await Instance.provide({
  directory: "/project/b",
  async fn() {
    GlobalBus.emit("event", {
      directory: "/project/a",
      payload: {
        type: Session.Event.Created.type,
        properties: {
          info: sessionInfo,
        },
      },
    })
  },
})
```

### 错误 3: 内存泄漏

```typescript
// ❌ 错误: 忘记取消订阅
Bus.subscribe(Event, handler)

// ✅ 正确
const unsub = Bus.subscribe(Event, handler)
// 使用完后
unsub()

// 或者使用 once
Bus.once(Event, handler)
```

### 错误 4: 并发问题

```typescript
// ❌ 错误: 手动处理并发
const data = await Bun.file(path).json()
// ... 修改 ...
await Bun.write(path, JSON.stringify(data))

// ✅ 正确: 使用 Storage（自带文件锁）
await Storage.update(["key"], (draft) => {
  draft.value++
})
```

---

## API 索引

### Global (`src/global/index.ts`)

- `Global.Path` - 路径常量

### Context (`src/util/context.ts`)

- `Context.create<T>(name)` - 创建上下文

### Instance (`src/project/instance.ts`)

- `Instance.provide(input)` - 提供实例上下文
- `Instance.directory` - 当前目录
- `Instance.worktree` - 当前工作树
- `Instance.project` - 当前项目
- `Instance.state(init, dispose)` - 创建实例状态
- `Instance.dispose()` - 释放实例
- `Instance.disposeAll()` - 释放所有实例

### State (`src/project/state.ts`)

- `State.create(root, init, dispose)` - 创建状态

### Config (`src/config/config.ts`)

- `Config.get()` - 获取配置
- `Config.update(config)` - 更新配置
- `Config.directories()` - 获取配置目录

### Bus (`src/bus/index.ts`)

- `Bus.publish(def, properties)` - 发布事件
- `Bus.subscribe(def, callback)` - 订阅事件
- `Bus.once(def, callback)` - 一次性订阅
- `Bus.subscribeAll(callback)` - 订阅所有事件

### Storage (`src/storage/storage.ts`)

- `Storage.read<T>(key)` - 读取
- `Storage.write<T>(key, content)` - 写入
- `Storage.update<T>(key, fn)` - 更新
- `Storage.remove(key)` - 删除
- `Storage.list(prefix)` - 列表

### Auth (`src/auth/index.ts`)

- `Auth.get(providerID)` - 获取认证
- `Auth.all()` - 获取所有认证
- `Auth.set(key, info)` - 设置认证
- `Auth.remove(key)` - 删除认证

### Log (`src/util/log.ts`)

- `Log.create(tags)` - 创建 logger
- `Log.init(options)` - 初始化日志
- `Log.file()` - 获取日志文件路径
- `Log.Default` - 默认 logger

### Installation (`src/installation/index.ts`)

- `Installation.VERSION` - 版本号
- `Installation.CHANNEL` - 渠道
- `Installation.USER_AGENT` - 用户代理
- `Installation.method()` - 安装方式
- `Installation.upgrade(method, target)` - 升级
- `Installation.latest()` - 最新版本

---

## 相关文件路径

| 模块         | 文件                        |
| ------------ | --------------------------- |
| Global       | `src/global/index.ts`       |
| Context      | `src/util/context.ts`       |
| Instance     | `src/project/instance.ts`   |
| State        | `src/project/state.ts`      |
| Bus          | `src/bus/index.ts`          |
| GlobalBus    | `src/bus/global.ts`         |
| Config       | `src/config/config.ts`      |
| Storage      | `src/storage/storage.ts`    |
| Auth         | `src/auth/index.ts`         |
| Log          | `src/util/log.ts`           |
| Installation | `src/installation/index.ts` |
| Project      | `src/project/project.ts`    |
| Session      | `src/session/index.ts`      |
| Flag         | `src/flag/flag.ts`          |

---

## 学习路径

1. **入门** (5 分钟)
   - 阅读 "01-全局状态分析.md" 的概述部分
   - 理解 Global, Config, Instance 的基本概念

2. **进阶** (30 分钟)
   - 阅读 "02-架构图与代码示例.md"
   - 运行代码示例，理解 Context 和 State
   - 实现一个简单的状态管理

3. **深入** (1 小时)
   - 阅读 "03-数据流与状态流转.md"
   - 跟踪一次完整的操作流程
   - 理解事件总线和缓存机制

4. **实践** (2 小时)
   - 使用本文档的常用模式创建一个 CLI 命令
   - 实现事件监听和处理
   - 使用 Storage 持久化数据

---

## 获取帮助

- 查看完整文档: `docs-learn/05-技术实现/04-cli 全局状态管理/`
- 查看代码: `packages/opencode/src/`
- 查看测试: `packages/opencode/test/`
