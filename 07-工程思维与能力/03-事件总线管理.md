# 事件总线管理机制

## 1. 概述

本代码库中的事件总线（Event Bus）是一个基于 TypeScript 命名空间的中央事件系统，用于实现模块间的松耦合通信。通过 `Bus.publish()` 发布事件，通过 `Bus.subscribe()` 订阅事件，实现解耦的架构设计。

---

## 2. Bus 类的核心实现

### 2.1 文件位置

`packages/opencode/src/bus/index.ts`

### 2.2 命名空间结构

```typescript
export namespace Bus {
  const log = Log.create({ service: "bus" })
  type Subscription = (event: any) => void

  // 实例级别的事件状态管理
  const state = Instance.state(
    () => {
      const subscriptions = new Map<any, Subscription[]>()
      return { subscriptions }
    },
    async (entry) => {
      // 清理逻辑：实例销毁时触发通配符订阅者
      const wildcard = entry.subscriptions.get("*")
      if (!wildcard) return
      const event = {
        type: InstanceDisposed.type,
        properties: { directory: Instance.directory },
      }
      for (const sub of [...wildcard]) {
        sub(event)
      }
    },
  )
}
```

### 2.3 核心方法

#### publish() - 发布事件

```typescript
export async function publish<Definition extends BusEvent.Definition>(
  def: Definition,
  properties: z.output<Definition["properties"]>,
) {
  const payload = {
    type: def.type,
    properties,
  }
  log.info("publishing", { type: def.type })

  const pending = []
  // 同时触发特定事件和通配符订阅者
  for (const key of [def.type, "*"]) {
    const match = state().subscriptions.get(key)
    for (const sub of match ?? []) {
      pending.push(sub(payload))
    }
  }

  // 同时发送到全局总线
  GlobalBus.emit("event", {
    directory: Instance.directory,
    payload,
  })

  return Promise.all(pending)
}
```

#### subscribe() - 订阅事件

```typescript
export function subscribe<Definition extends BusEvent.Definition>(
  def: Definition,
  callback: (event: { type: Definition["type"]; properties: z.output<Definition["properties"]> }) => void,
) {
  return raw(def.type, callback)
}

function raw(type: string, callback: (event: any) => void) {
  log.info("subscribing", { type })
  const subscriptions = state().subscriptions
  let match = subscriptions.get(type) ?? []
  match.push(callback)
  subscriptions.set(type, match)

  // 返回取消订阅函数
  return () => {
    log.info("unsubscribing", { type })
    const match = subscriptions.get(type)
    if (!match) return
    const index = match.indexOf(callback)
    if (index === -1) return
    match.splice(index, 1)
  }
}
```

#### once() - 一次性订阅

```typescript
export async function once<Definition extends BusEvent.Definition>(
  def: Definition,
  callback: (event: { type: Definition["type"]; properties: z.output<Definition["properties"]> }) => "done" | undefined,
) {
  const unsub = subscribe(def, (event) => {
    if (callback(event)) unsub() // 回调返回 "done" 时取消订阅
  })
}
```

#### subscribeAll() - 订阅所有事件

```typescript
export function subscribeAll(callback: (event: any) => void) {
  return raw("*", callback) // 使用通配符订阅所有事件
}
```

---

## 3. BusEvent 定义模式

### 3.1 文件位置

`packages/opencode/src/bus/bus-event.ts`

### 3.2 定义机制

```typescript
export namespace BusEvent {
  const log = Log.create({ service: "event" })

  export type Definition = ReturnType<typeof define>

  // 全局事件注册表
  const registry = new Map<string, Definition>()

  // 定义事件的核心函数
  export function define<Type extends string, Properties extends ZodType>(type: Type, properties: Properties) {
    const result = {
      type,
      properties,
    }
    registry.set(type, result) // 自动注册到全局注册表
    return result
  }

  // 生成所有事件载荷的联合类型
  export function payloads() {
    return z
      .discriminatedUnion(
        "type",
        registry
          .entries()
          .map(([type, def]) =>
            z
              .object({
                type: z.literal(type),
                properties: def.properties,
              })
              .meta({ ref: "Event" + "." + def.type }),
          )
          .toArray() as any,
      )
      .meta({ ref: "Event" })
  }
}
```

---

## 4. 事件名称命名规范

### 4.1 命名约定

采用 **层级式命名结构**：`模块.子模块.动作`

### 4.2 事件名称列表

| 事件名称               | 定义位置             | 用途               |
| ---------------------- | -------------------- | ------------------ |
| `session.created`      | Session.Event        | Session 创建       |
| `session.updated`      | Session.Event        | Session 更新       |
| `session.deleted`      | Session.Event        | Session 删除       |
| `session.diff`         | Session.Event        | Session 差异       |
| `session.error`        | Session.Event        | Session 错误       |
| `session.status`       | SessionStatus.Event  | 会话状态变化       |
| `session.idle`         | SessionStatus.Event  | 会话空闲（已废弃） |
| `message.updated`      | MessageV2.Event      | 消息更新           |
| `message.removed`      | MessageV2.Event      | 消息删除           |
| `message.part.updated` | MessageV2.Event      | 消息部分更新       |
| `message.part.removed` | MessageV2.Event      | 消息部分删除       |
| `pty.created`          | PTY.Event            | PTY 创建           |
| `pty.updated`          | PTY.Event            | PTY 更新           |
| `pty.exited`           | PTY.Event            | PTY 退出           |
| `pty.deleted`          | PTY.Event            | PTY 删除           |
| `file.watcher.updated` | FileWatcher.Event    | 文件监视器更新     |
| `permission.asked`     | PermissionNext.Event | 权限请求           |
| `permission.replied`   | PermissionNext.Event | 权限回复           |

### 4.3 标准化动作动词

| 动词                  | 用途     |
| --------------------- | -------- |
| `Created` / `created` | 资源创建 |
| `Updated` / `updated` | 资源更新 |
| `Deleted` / `deleted` | 资源删除 |
| `Added` / `added`     | 添加子项 |
| `Removed` / `removed` | 移除子项 |
| `Asked` / `asked`     | 发起请求 |
| `Replied` / `replied` | 响应请求 |

---

## 5. 各模块事件定义

### 5.1 Session 事件

**文件**: `packages/opencode/src/session/index.ts`

```typescript
export namespace Session {
  export const Event = {
    Created: BusEvent.define(
      "session.created",
      z.object({
        info: Info,
      }),
    ),

    Updated: BusEvent.define(
      "session.updated",
      z.object({
        info: Info,
      }),
    ),

    Deleted: BusEvent.define(
      "session.deleted",
      z.object({
        info: Info,
      }),
    ),

    Diff: BusEvent.define(
      "session.diff",
      z.object({
        sessionID: z.string(),
        diff: Snapshot.FileDiff.array(),
      }),
    ),

    Error: BusEvent.define(
      "session.error",
      z.object({
        sessionID: z.string().optional(),
        error: MessageV2.Assistant.shape.error,
      }),
    ),
  }
}
```

### 5.2 MessageV2 事件

**文件**: `packages/opencode/src/session/message-v2.ts`

```typescript
export namespace MessageV2 {
  export const Event = {
    Updated: BusEvent.define(
      "message.updated",
      z.object({
        info: Info,
      }),
    ),

    Removed: BusEvent.define(
      "message.removed",
      z.object({
        sessionID: z.string(),
        messageID: z.string(),
      }),
    ),

    PartUpdated: BusEvent.define(
      "message.part.updated",
      z.object({
        part: Part,
        delta: z.string().optional(),
      }),
    ),

    PartRemoved: BusEvent.define(
      "message.part.removed",
      z.object({
        sessionID: z.string(),
        messageID: z.string(),
        partID: z.string(),
      }),
    ),
  }
}
```

### 5.3 PTY 事件

**文件**: `packages/opencode/src/pty/index.ts`

```typescript
export namespace PTY {
  export const Event = {
    Created: BusEvent.define("pty.created", z.object({ info: Info })),
    Updated: BusEvent.define("pty.updated", z.object({ info: Info })),
    Exited: BusEvent.define(
      "pty.exited",
      z.object({
        id: Identifier.schema("pty"),
        exitCode: z.number(),
      }),
    ),
    Deleted: BusEvent.define(
      "pty.deleted",
      z.object({
        id: Identifier.schema("pty"),
      }),
    ),
  }
}
```

### 5.4 FileWatcher 事件

**文件**: `packages/opencode/src/file/watcher.ts`

```typescript
export namespace FileWatcher {
  export const Event = {
    Updated: BusEvent.define(
      "file.watcher.updated",
      z.object({
        file: z.string(),
        event: z.union([z.literal("add"), z.literal("change"), z.literal("unlink")]),
      }),
    ),
  }
}
```

### 5.5 Permission 事件

**文件**: `packages/opencode/src/permission/next.ts`

```typescript
export namespace PermissionNext {
  export const Event = {
    Asked: BusEvent.define("permission.asked", Request),

    Replied: BusEvent.define(
      "permission.replied",
      z.object({
        sessionID: z.string(),
        requestID: z.string(),
        reply: Reply,
      }),
    ),
  }
}
```

---

## 6. 事件发布示例

### 6.1 Session 创建时发布

```typescript
// packages/opencode/src/session/index.ts
export async function createNext(input: { ... }) {
  const result: Info = { /* ... */ }
  log.info("created", result)
  await Storage.write(["session", Instance.project.id, result.id], result)

  // 发布 Created 事件
  Bus.publish(Event.Created, {
    info: result,
  })

  // ...其他逻辑...

  // 发布 Updated 事件
  Bus.publish(Event.Updated, {
    info: result,
  })

  return result
}
```

### 6.2 Session 更新时发布

```typescript
// packages/opencode/src/session/index.ts
export async function update(id: string, editor: (session: Info) => void) {
  const project = Instance.project
  const result = await Storage.update<Info>(["session", project.id, id], (draft) => {
    editor(draft)
    draft.time.updated = Date.now()
  })

  // 发布 Updated 事件
  Bus.publish(Event.Updated, {
    info: result,
  })

  return result
}
```

### 6.3 文件监视器发布

```typescript
// packages/opencode/src/file/watcher.ts
const subscribe: ParcelWatcher.SubscribeCallback = (err, evts) => {
  if (err) return
  for (const evt of evts) {
    if (evt.type === "create") Bus.publish(Event.Updated, { file: evt.path, event: "add" })
    if (evt.type === "update") Bus.publish(Event.Updated, { file: evt.path, event: "change" })
    if (evt.type === "delete") Bus.publish(Event.Updated, { file: evt.path, event: "unlink" })
  }
}
```

### 6.4 会话状态变化时发布

```typescript
// packages/opencode/src/session/status.ts
export function set(sessionID: string, status: Info) {
  Bus.publish(Event.Status, {
    sessionID,
    status,
  })

  if (status.type === "idle") {
    // deprecated
    Bus.publish(Event.Idle, {
      sessionID,
    })
    delete state()[sessionID]
    return
  }
  state()[sessionID] = status
}
```

---

## 7. 事件订阅示例

### 7.1 Share 模块订阅

**文件**: `packages/opencode/src/share/share.ts`

```typescript
export function init() {
  Bus.subscribe(Session.Event.Updated, async (evt) => {
    await sync("session/info/" + evt.properties.info.id, evt.properties.info)
  })

  Bus.subscribe(MessageV2.Event.Updated, async (evt) => {
    await sync("session/message/" + evt.properties.info.sessionID + "/" + evt.properties.info.id, evt.properties.info)
  })

  Bus.subscribe(MessageV2.Event.PartUpdated, async (evt) => {
    await sync(
      "session/part/" +
        evt.properties.part.sessionID +
        "/" +
        evt.properties.part.messageID +
        "/" +
        evt.properties.part.id,
      evt.properties.part,
    )
  })
}
```

### 7.2 ShareNext 模块订阅

**文件**: `packages/opencode/src/share/share-next.ts`

```typescript
export async function init() {
  Bus.subscribe(Session.Event.Updated, async (evt) => {
    await sync(evt.properties.info.id, [
      {
        type: "session",
        data: evt.properties.info,
      },
    ])
  })

  Bus.subscribe(MessageV2.Event.Updated, async (evt) => {
    await sync(evt.properties.info.sessionID, [
      {
        type: "message",
        data: evt.properties.info,
      },
    ])

    if (evt.properties.info.role === "user") {
      await sync(evt.properties.info.sessionID, [
        {
          type: "model",
          data: [
            await Provider.getModel(evt.properties.info.model.providerID, evt.properties.info.model.modelID).then(
              (m) => m,
            ),
          ],
        },
      ])
    }
  })

  Bus.subscribe(MessageV2.Event.PartUpdated, async (evt) => {
    await sync(evt.properties.part.sessionID, [
      {
        type: "part",
        data: evt.properties.part,
      },
    ])
  })

  Bus.subscribe(Session.Event.Diff, async (evt) => {
    await sync(evt.properties.sessionID, [
      {
        type: "session_diff",
        data: evt.properties.diff,
      },
    ])
  })
}
```

---

## 8. 避免事件名称冲突的管理策略

### 8.1 层级式命名规范

采用 `模块.子模块.动作` 的层级命名方式：

```
session.created
session.updated
message.updated
message.part.updated
file.watcher.updated
permission.asked
pty.created
```

**优点**：

- 清晰的层级关系
- 自动按模块分组
- 易于查找和理解

### 8.2 全局注册表

```typescript
const registry = new Map<string, Definition>()

export function define<Type extends string, Properties extends ZodType>(type: Type, properties: Properties) {
  const result = { type, properties }
  registry.set(type, result) // 自动注册
  return result
}
```

**优点**：

- 所有事件自动注册到中心位置
- 便于追踪和调试
- 支持生成联合类型
- 可扩展为检测重复定义

### 8.3 类型安全保障

#### Zod Schema 验证

```typescript
Created: BusEvent.define(
  "session.created",
  z.object({
    info: Info, // 强类型定义
  }),
)
```

#### TypeScript 泛型约束

```typescript
export async function publish<Definition extends BusEvent.Definition>(
  def: Definition,
  properties: z.output<Definition["properties"]>,
)
```

**优点**：

- 编译时类型检查
- 运行时数据验证
- IDE 自动补全
- 防止类型错误

### 8.4 命名空间封装

```typescript
export namespace Session {
  export const Event = {
    Created: BusEvent.define("session.created", ...),
    Updated: BusEvent.define("session.updated", ...),
  }
}
```

**访问方式**: `Session.Event.Created`、`MessageV2.Event.PartUpdated`

**优点**：

- 事件定义与模块逻辑内聚
- 避免全局命名空间污染
- 通过 TypeScript 路径访问，语义清晰

### 8.5 实例级别隔离

```typescript
const state = Instance.state(
  () => {
    const subscriptions = new Map<any, Subscription[]>()
    return { subscriptions }
  },
  async (entry) => {
    // 实例销毁时清理
  },
)
```

**优点**：

- 每个项目实例独立管理订阅
- 避免跨实例事件干扰
- 支持实例级清理

---

## 9. 事件流程示例

### 场景：用户创建新的 Session

```
1. 用户触发创建操作
   ↓
2. Session.createNext() 执行
   ↓
3. 创建 Session.Info 对象
   ↓
4. 存储到 Storage
   ↓
5. Bus.publish(Session.Event.Created, { info: result })
   ↓
6. 事件分发给所有订阅者：
   - Share 模块 → 同步到服务器
   - ShareNext 模块 → 更新分享链接
   - 其他订阅者...
```

---

## 10. 设计亮点总结

| 特性             | 说明                                 |
| ---------------- | ------------------------------------ |
| **Schema-First** | 所有事件使用 Zod 定义，确保类型安全  |
| **自动注册**     | 事件定义时自动注册到全局注册表       |
| **实例隔离**     | 每个项目实例独立管理订阅             |
| **类型安全**     | TypeScript 泛型 + Zod 确保类型正确   |
| **取消订阅**     | subscribe 返回取消函数，支持动态管理 |
| **通配符订阅**   | 支持 `"*"` 订阅所有事件，便于调试    |
| **全局总线**     | 通过 GlobalBus 支持跨实例监听        |

---

## 11. 关键文件路径

| 文件                                          | 说明                      |
| --------------------------------------------- | ------------------------- |
| `packages/opencode/src/bus/index.ts`          | Bus 类核心实现            |
| `packages/opencode/src/bus/bus-event.ts`      | BusEvent 定义             |
| `packages/opencode/src/bus/global.ts`         | 全局总线                  |
| `packages/opencode/src/session/index.ts`      | Session.Event 定义        |
| `packages/opencode/src/session/message-v2.ts` | MessageV2.Event 定义      |
| `packages/opencode/src/pty/index.ts`          | PTY.Event 定义            |
| `packages/opencode/src/file/watcher.ts`       | FileWatcher.Event 定义    |
| `packages/opencode/src/permission/next.ts`    | PermissionNext.Event 定义 |
| `packages/opencode/src/session/status.ts`     | SessionStatus.Event 定义  |
| `packages/opencode/src/share/share.ts`        | 订阅示例                  |
| `packages/opencode/src/share/share-next.ts`   | 订阅示例                  |
